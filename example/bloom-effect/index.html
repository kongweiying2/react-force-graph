<head>
  <style> body { margin: 0; } </style>

  <script src="//unpkg.com/react/umd/react.production.min.js"></script>
  <script src="//unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
  <script src="//unpkg.com/@babel/standalone"></script>

  <script src="//unpkg.com/react-force-graph-3d"></script>
  <!--<script src="../../src/packages/react-force-graph-3d/dist/react-force-graph-3d.js"></script>-->
</head>

<body>
  <div id="graph"></div>

  <script type="importmap">{ "imports": { "three": "//unpkg.com/three/build/three.module.js" }}</script>
  <script type="text/jsx" data-type="module">
    import { UnrealBloomPass } from '//unpkg.com/three/examples/jsm/postprocessing/UnrealBloomPass.js';

    const { useRef, useEffect } = React;

    fetch('../datasets/lifemap.json').then(res => res.json()).then(data => {
      const FocusGraph = () => {
        const fgRef = useRef();

        useEffect(() => {
          const bloomPass = new UnrealBloomPass();
          bloomPass.strength = 5;
          bloomPass.radius = 1;
          bloomPass.threshold = 0;
          fgRef.current.postProcessingComposer().addPass(bloomPass);

          const timer = setTimeout(() => {
            if (fgRef.current) {
              // Use the zoomToFit function to automatically fit the graph in view
              fgRef.current.zoomToFit(2000, 50, node => true);
            }
          }, 1500); // 2000ms = 2 seconds delay

          // Cleanup function to clear the timeout if the component unmounts
          return () => clearTimeout(timer);
        }, []);

        // Define a color palette for groups with bright, vivid, and inspiring colors
        const groupColors = {
          0: '#FF5733',  // Red-Orange
          1: '#33FF57',  // Lime Green
          2: '#3357FF',  // Blue
          3: '#FF33A8',  // Pink
          4: '#FF8F33',  // Orange
          5: '#33FFF3',  // Cyan
          6: '#8D33FF',  // Purple
          7: '#FF3333',  // Bright Red
          8: '#33FF8D',  // Bright Green
          9: '#FF33F6',  // Magenta
          10: '#33A1FF', // Sky Blue
          11: '#A133FF', // Violet
          12: '#FFB833', // Golden
          13: '#33FFD5', // Turquoise
          14: '#FF33EC', // Hot Pink
          15: '#FFD433'  // Yellow
        };

        // Determine the maximum recency value for normalization
        const maxRecency = 302; // Based on lifemap.json

        return (
          <ForceGraph3D
            ref={fgRef}
            backgroundColor="#000003"
            graphData={data}
            nodeVal={node => Math.pow(node.importance, 2.5)} // Dynamic node size based on importance
            nodeColor={node => {
              // Get the base color from the group
              const baseColor = groupColors[node.group] || '#FFFFFF'; // Default to white if group not found

              // Normalize recency to a brightness factor between 0.3 and 1
              const brightnessFactor = 0.3 + (node.recency / maxRecency) * 0.7;

              // Function to adjust brightness of a hex color
              const adjustBrightness = (hex, factor) => {
                const r = Math.min(255, Math.max(0, Math.floor(parseInt(hex.slice(1, 3), 16) * factor)));
                const g = Math.min(255, Math.max(0, Math.floor(parseInt(hex.slice(3, 5), 16) * factor)));
                const b = Math.min(255, Math.max(0, Math.floor(parseInt(hex.slice(5, 7), 16) * factor)));
                return `rgb(${r}, ${g}, ${b})`;
              };

              return adjustBrightness(baseColor, brightnessFactor);
            }}
            nodeLabel="id"
            // Removed nodeAutoColorBy to prevent conflict with custom nodeColor
          />
        );
      };

      ReactDOM.render(
        <FocusGraph/>,
        document.getElementById('graph')
      );
    });
  </script>
</body>